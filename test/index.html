<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8" />
  <title>MathJSON REPL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <style>
    code {
      white-space: pre-wrap;
    }

    h2 {
      font-size: 1em;
      padding: 0;
      margin: 0;
      color: #666;
    }

    .latex {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      margin-top: .5em;
      background: #fdfdfd;

    }

    .output-section.is-visible { display: block; }
    .output-section { display: none; } 
  </style>
  <script src="https://unpkg.com/mathlive/dist/mathlive.min.js"></script>
</head>

<body>
  <header>
    <h1>MathJSON REPL</h1>
  </header>
  <main>
    <math-field id="mf" class="mathfield" style="width:100%" tabindex="0" virtual-keyboard-mode="manual">
      \Z
      <!-- \sqrt{1}[3] -->
      <!-- \sin(x -->
      <!-- x=\frac{-b\pm\sqrt{b^2-4ac}} {2a} -->
      <!-- 2^3^4 -->
      <!-- \sqrt{1}[3] -->
      <!-- = should produce error or Missing = Missing ->
      <!-- x=\frac{-b\pm \sqrt{b^2-4ac}}{2a} -->
      <!-- (b^3c^2d)(x^7y)(a^5f)(b^2x^5b3) -->
      <!-- {}_3^2 -->
    </math-field>
    <!-- 2{xy}     1+|a+|2|+b| -->
    <!-- ,c,b -->
    <!-- a,c, -->
    <!-- a,, c -->
    <!-- x{}_{p+1}^{q+1}x_{r+1}^{s+1} -->
    <!-- 12+ should generate ["Add", 12]-->
    <!-- \lbrack\rbrack -->
    <!-- \foo  -->
    <!-- a\le b \overline{z} \overrightarrow{ABC} -->
    <!-- \partial^2_{x,y} f(x,y) -->
    <!-- -0+0(\frac{0}{\frac{0}{0}}-0)+x^\pi -->
    <!-- -0+0(\frac{0}{\frac{0}{0}}-0) -->
    <!-- x_0 + x_{0} +  x_n + x_{n+1}-->
    <!-- -2x5z\sqrt{y}\frac{3}{4}3\pi y} -->
    <!-- \sin^{-1}\prime(x)      \sin^{-1}'(x) -- >
        <!-- "\begin{align*}\dot{x} & =\sigma(y-x) \\ \dot{y} & =\rho x-y-xz \\ \dot{z} & =-\beta z+xy\end{align*}" ->
        <!-- 2{xy} should create group -->

    <!-- -(x) -->
    <!-- -5-3-2 -->
    <!-- -123, +456.789, -->
    <!-- x_{0} -->
    <!-- -123, 456.789, -->
    <!-- |(a+|b|+1)| -->
    <!-- i, 2i, -i -->
    <!-- (a,,b) -->
    <!-- x_5 -->
    <!-- (\mathtt{dead\;beef})_{16} -->
    <!-- (x,,2) -->
    <!-- $$(deadbeef)_{16}$$ -->

    <!-- \huge x \text{y} -->
    <!-- \scriptscriptstyle x \text{y} -->
    <!-- \sqrt[\Huge 3]{29} -->
    <!-- x^{\binom{n}{k}} -->
    <!-- \binom12 \textstyle \binom34 \scriptstyle \binom56 \displaystyle \binom78 \scriptstyle \binom90 -->
    <!-- \int^b_a x^2 dx -->
    <!-- \int^b_a\int^c_d x^2 dx dy -->
    <!-- \int x^2 + x = 0 -->
    <!-- \int x^2 + x dx = 0 -->
    <!-- \int (x^2 + x) dx = 0 -->

    <h2>Input Latex</h2>
    <div class="output" id="latex"></div>
    <h2>Input ASCIIMath</h2>
    <div class="output" id="asciimath"></div>

    <div class="output-section" id='raw-form'>
      <h2>MathJSON Raw</h2>
      <div class="output mathjson"></div>  
    </div>

    <div class="output-section" id="full-form">
      <h2>MathJSON Full Form</h2>
      <div class="output mathjson"></div>  
    </div>

    <div class="output-section" id="canonical-form">
      <h2>MathJSON Canonical Form</h2>
      <div class="output mathjson"></div>
    </div>

    <div class="output-section" id="domain">
      <h2>Domain</h2>
      <div class="latex"></div>
      <div class="output math-json"></div>
    </div>

    <div class="output-section" id="simplify">
      <h2>Simplify</h2>
      <div class="latex"></div>
      <div class="output mathjson"></div>
    </div>

    <div class="output-section" id='evaluate'>
      <h2>Evaluate</h2>
      <div class="latex"></div>
      <div class="output mathjson"></div>
    </div>

    <div class="output-section" id="evaluate-numerically">
      <h2>Evaluate Numerically</h2>
      <div class="latex"></div>
      <div class="output math-json"></div>
    </div>
  </main>

  <script type="module">
    import { convertLatexToMarkup } from 
      'https://unpkg.com/mathlive/dist/mathlive.min.mjs';
    import { LatexSyntax } from '../dist/math-json.esm.js';
    import { ComputeEngine } from '../dist/compute-engine.esm.js';


    let errors = [];
    const defaultLatex = new LatexSyntax(
      {
        onError: (err) => {
          if (err.before && err.after) {
            errors.push(err.code +
              (err.arg ? ': ' + err.arg : '') +
              '\n' +
              '|  ' +
              err.before +
              err.after +
              '\n' +
              '|  ' +
              String(' ').repeat(err.before.length) +
              'â–²',
            )
          } else {
            errors.push(err.code +
              (err.arg ? ': ' + err.arg : '')
            )
          }
        },
        promoteUnknownSymbols: /^[a-z]+/,
        dictionary:
          [...LatexSyntax.getDictionary(),
          {
            name: 'Missing',
            serialize: ''
          },
          {
            name: 'Speed',
            trigger: { symbol: ['s', 'p', 'e', 'e', 'd'] }
          }
          ]

      });
    const rawLatex = new LatexSyntax(
      {
        invisibleOperator: '',
        invisiblePlusOperator: '',
        dictionary: [],
        promoteUnknownSymbols: /./,

        parseArgumentsOfUnknownLatexCommands: true,
        parseNumbers: false,
        onError: (err) =>
          errors.push(err.code + (err.arg ? ' ' + err.arg : '')),
      });
    const ce = new ComputeEngine();

    ce.assume('x', ['Greater', 0]);
    ce.assume('n', 'Integer');

    // console.log(defaultLatex.parse('3\\times x + 1'));
    // console.log(defaultLatex.parse('1 + x + x + x'));

    // console.log(
    //   computeEngine.canonical(defaultLatex.parse('3\\times x + 1'))
    // );
    // console.log(
    //   computeEngine.canonical(defaultLatex.parse('1 + x + x + x'))
    // );
    // console.log(
    //   await computeEngine.evaluate(defaultLatex.parse('3\\times x + 1')),
    //   await computeEngine.evaluate(defaultLatex.parse('1 + x + x + x'))
    // );

    // console.log(computeEngine.same(
    //   computeEngine.evaluate(defaultLatex.parse('3\\times x + 1')),
    //   computeEngine.evaluate(defaultLatex.parse('1 + x + x + x'))
    // ));


    const mf = document.getElementById('mf');
    mf.addEventListener('input', (ev) => updateContent(mf));
    updateContent(mf);

    async function updateContent(mf) {
      const latex = mf.getValue('latex');
      try {

        document.getElementById('latex').innerHTML = escapeHtml(latex);

        document.getElementById('asciimath').innerHTML = 
          escapeHtml(mf.getValue('ascii-math'));


        let expr = defaultLatex.parse(latex);

        const canonicalExpr = ce.format(expr, ['canonical']);

        updateExpr(canonicalExpr, 'canonical-form');


        updateExpr(ce.format(expr, ['full']), 'full-form');

        updateExpr(ce.format(rawLatex.parse(latex), ['full']), 
          'raw-form');

        updateExpr(await ce.domain(expr), 'domain');

        updateExpr(await ce.simplify(expr), 'simplify');

        updateExpr(await ce.evaluate(expr), 'evaluate');

        updateExpr(await ce.N(expr), 'evaluate-numerically');

      } catch (e) {
        console.error("Error converting %c " + latex + '%c ' +
          e.toString(), 'color: red;  background: hsla(0, 60%, 90%)', 'background: transparent');
      }
    }

    function updateExpr(expr, id) {
      errors = [];

      const el = document.getElementById(id);
      if (!el) return;

      if (!expr) {
        el.classList.remove('is-visible');
      } else {
        el.classList.add('is-visible');
      }

      const mathJsonEl = el.querySelector('.mathjson');
      if (mathJsonEl) {
        mathJsonEl.innerHTML =
          escapeHtml(JSON.stringify(expr, null, 2)) +
          '<br><div style="font-weight: bold; color: hsl(4deg, 90%, 50%)">' +
          errors.join('<br>') + '</div>';
      }
      const latexEl = el.querySelector('.latex');
      if (latexEl) {
        latexEl.innerHTML =
          convertLatexToMarkup(defaultLatex.serialize(expr));
      }

      errors = [];
    }

    function escapeHtml(string) {
      return String(string).replace(/[&<>"'`=/\u200b]/g, function (s) {
        return (
          {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
            '/': '&#x2F;',
            '`': '&#x60;',
            '=': '&#x3D;',
            '\u200b': '&amp;#zws;',
          }[s] || s
        );
      });
    }
  </script>
</body>

</html>